
# 如何利用curl命令访问Kubernetes API server

kubectl 通过访问 Kubernetes API 来执行命令。我们也可以通过对应的TLS key， 使用curl 或是 golang client做同样的事。

API 请求必须使用 JSON 格式来发送。kubectl 的作用是将 yaml 转换为 JSON 格式进行 API 请求。

1、我们从查看 kubectl 的配置文件开始，需要：三个证书和 API server 的地址：

```
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJd01EZ3dPVEEwTWpNeE9Gb1hEVE13TURnd056QTBNak14T0Zvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTU14CkZzZU9CMVNva2VURTNzNWZMSVhkd2x6NzQ5MDVHU2g3clVhaXJ5Z2VvSms5L2o2Z3ZPdWQxOU91M1RqQTlwRXkKV2htYWFoL0I2KzE1Z2pLZjlIak1yMzhQaFRnTzYwVDl4V2VPem1kWTlKZnFVSzdWaTUrUXBCbFJZUTVVeUU5WQpZQkxJV0FZS1pVbXNIRjNLaVE1MGg3RFBVVzl3TitlWlE1WHcwblhrNzlLc1o1MVpYWTNZMUJsd2xPcDF5cHBSClA0VzV2bFhpcFlXeDlsRWlCYzNXU0YybnRsdVpCc1Nvcm9FUEdlT2tLNWZNWXlySThHdDY0VnJTSER0SVVIMmsKOUJQUjlFTlJzRUJrNyttV3o3a2NoUk16cnBBMStuK1hHVXFkektnVjNSeUhpUVM1Rmx3V3BEM1ZyaHZsVytOVgpQblhtYmV3NVBWNWx1eFZ5ZzJjQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFKa3AyV1l4VzZqY2gzQitoc2tpNmhidktvM2EKb0pqbmZSWUZtQW5ycVNNUGZHU3Ria1NlKzYzMnR2NWFLYmcyMHc1WklGcFJUcHJJNXo2ZVNzLzYxQTA0NlJUKwpvRHJNUWNDUGZkd0hHU1pxM2dEQmd4Zmc4YkVod2lTSG9IWncyY0xLVTVCMGFqVDJFdWtVbWdMdFRZL0lYVWZUClFLZTBydzdSbHBLSFNhNjM2VzZtdk8wL1BwSjRkcGhMbGdoZEFVYXlnVDg2ajRpdW9NMGVMeHFqc1hOMzJob1AKeEJNRGtHTjR1akVuOHIyVHJoQVg0NjUyVyt0LzVvTnU1bkxYbW1ld2xORWJRK0RhenZjRFBuak1ISXF2MmV1RgovcXAzbHdTbFU0bGxnYlFiQ2ZoZEpHaExuNWJqZVZVN0dOOVdUSXhDQXJ4cmYvRllsV3p4NC9OUzQ1Zz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    server: https://192.168.56.100:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBZ0lJRnJ2NzludVVQQjh3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TURBNE1Ea3dOREl6TVRoYUZ3MHlNVEE0TURrd05ESXpNakJhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXVtV08zMlhLSmQvMC9pUDgKVmErRXV0ejMzRDVqK2dBRTRsU0hlSHFkK1JJS0VNY1FNTjFuQTRhSmF2N0I1bW81cWxVMzN0UXZGZ1NxekpBRgp3YU02dkRVWGJKd254U2tFelRTVnFieXVyeDJNajRTWVNUSXZMVE1UdG9uc2x4bFpMMHU2eXZOR0N6QkJqaVZtCnNPZzNkNGdXNEtoU2dnOWNEemwvUzM5VWRtNVlTblh6bGNDemNhNGhMYUN5SktHcURteUZxVUlIcUEzVlVEQ1kKcmlIY0VXam8zYjE0T0RDeGlUMktzYkFlRDFPdytEeDBaY3Q1U3B5L0svL1JLOEVxK0VUWk9BKy9CY2NPeW9FRApkWWU0NkhUUFZGKzM1NUVrbk1zdEJtRzlncmpnZ0pyd0syeisrTWtoZ1dMdUYyMy9WT2JlUzF6NHMzeWNvS3RvClJFUW9zUUlEQVFBQm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFITTlpemVNQkVvbGpOcHBsRVpMMDkwaU1HTUdqOWtMcTVqSwpTVlpYTHNEUVNZczZlaDEydEVMeHU5eG1nWlhrNmdDazF3VEtVc0E3dXhrditkQnNIN3BRb3lycG5uc3crTnVKCmZkUnVOWHNnOEp3eXQxR0J6QmphUTFZaXlWWEhrbHB1bXhZM1BWcHNXKzc3NlJYRXliQitDREplSmtrSTdDd0EKWWZzL2p6QlZDMGFIc1BYRmxtZUtPdWsweHdoQWl5YThCUjZXdGdGNTA5UVh1aTJBN0ZDSUk0N2lMQjhXK1BDUAorajNsaHN1SFpuRWxyZklsRE12czFRS3Nnb2Q2UTNYUmxnMVVPdG1qSmVBS1JSRU1QaTJoeEkxWHQ4MGxWV0laCnFlSzIxMnUyaGg5aVNIbGlRVXhva0ZsVXJpVjFXeFJoRlZ5LzNKQngyeXA1bnd4T0hqND0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdW1XTzMyWEtKZC8wL2lQOFZhK0V1dHozM0Q1aitnQUU0bFNIZUhxZCtSSUtFTWNRCk1OMW5BNGFKYXY3QjVtbzVxbFUzM3RRdkZnU3F6SkFGd2FNNnZEVVhiSndueFNrRXpUU1ZxYnl1cngyTWo0U1kKU1RJdkxUTVR0b25zbHhsWkwwdTZ5dk5HQ3pCQmppVm1zT2czZDRnVzRLaFNnZzljRHpsL1MzOVVkbTVZU25YegpsY0N6Y2E0aExhQ3lKS0dxRG15RnFVSUhxQTNWVURDWXJpSGNFV2pvM2IxNE9EQ3hpVDJLc2JBZUQxT3crRHgwClpjdDVTcHkvSy8vUks4RXErRVRaT0ErL0JjY095b0VEZFllNDZIVFBWRiszNTVFa25Nc3RCbUc5Z3JqZ2dKcncKSzJ6KytNa2hnV0x1RjIzL1ZPYmVTMXo0czN5Y29LdG9SRVFvc1FJREFRQUJBb0lCQUdEUWp6MEpxYzJ5WFpZRApLdlYyalFKaDgzdTZERU8xN3RPQUJEMVhzdVhEc09hMS9ucmpCTGFZRXBnNGFvNDdibWhDaXhwNksxck1ZY3FPCm8rN0gwYUlnRVdLZ1dTZlcvbDkzaUtUNUUrSncvcWtzdmN5Ry9Hb0Z0WitDVkJqSFdjTnZHajUvelVuU2JycGUKUXRCd1RSOFEySkVuM0hNaGR6ZVJMY1VSQmRYYzUxTy9Cdm9DbU5yM25ta2JRM0c0Rml6ekg3YWhGaVFMbldoRgpSNHJON05HVzUyUlVsWWdqTVRmbVBlOHUzZ0U3MHBRUXFoK1NHOFQrR3ZBTERrTEg1ZHBSSm45MFhqa05od3VIClJCVHcza09aeWdBai9sQ3hCZmwzVjc4MDkxZHN6WnF1cE5keHFWVmxkQXlEQ0c3c2FJV0xBR1N4N2pIQTk3Y1MKN1dxdHBnRUNnWUVBNWlJMVg2SjgxaHFta2RyY2RRRS9CR2xNVzh0eHNnQjhBa1pPall5NElPM2FRSHROcjl3egpJOGNGdWgydFVwZlNobng4ZHRTYWc4Y1Z3R1Flb1d4U2hGR2hZTU4wL0xLN0gvZk1IYm1aWlpTS0N1R0JIaWRRCkJSWXNQc1J6TUdnZWdra2pVa2ZJbXd4Y013ei9hdEh2MjVTRWhmaFdITHlXQWYyTlNaUFpyeWtDZ1lFQXoxamcKcDd5UVQrbFlsMUhaKy9GTlNoalA3ZDZIbnJkQ1pYTW1rb0FDdTNHQW9jMWhGcWgwUDRXRUhxR0RCc25MdmNSWQpHWm9mdWhQMzNVaDNYckUvUy9kakJ6aW92Qll4TElzK2I3aElxeUptdVd5UlBacVlyQ3Y1RzdGU01jMGozY1R4Ck5uc1daVzlLM2hNNjNWS3hTSjRmd2lmdWVJdURjUitVQWpCc1Jra0NnWUVBNWE4a3VBTlROdGs0Z0FBQTRhSlIKdzlSWVNwR2RNdnY2eU1aazVpK1pJZnhpUk5NTHNVWkRvQ1NsMmFCKytSemdHQ3VzaVdrZG9nSVQrb1d5Y0lmTgpQNVM5VFBjbkRvSlA4dEw5WEhsOTJQMU1YUm0rSlZzMUtTNTlFRlEvWndPejEzS3BseGhmNWllSzZjVENNMW0rClc5ZzUvLy9mNmlScVR5aEJXRHNCR3lrQ2dZQU56UEtXOTN2N2RhS0ozODdNY0JFZTMydm5meW96ckNybEtiYmwKaFZPcE9qSy9ralhtRml3MmxpSm5ENFR6RExkYzJCYXREWThUQ1lVejIwRG1zcEZ0OHZkS1ljRUpVOGpPR0M1OQpyUnhaRjU4U3RHRXVZbjNLNTlwYXQ0Q3JBK1poT2x4N3JkR2R5cnlHNzJ5NWttbHVWZWZ6T2trckNNNGsxMTg0CmpoU0cwUUtCZ0VBV0cyTTd6UWZDTmFWZ0ZkTzNRTm4zM3ltczRKbDE2Q1F0Q1FVSHVadUsvNkxnQnFXN3U4R2kKOFA1c2FwYk5TUkVnOXY4d3gwZUpLMWNyWmdHN3ByRHFiSldoektRR004bk12MVZrZ01nNlJaVGNyT212S1hWdApyVW1PeFdPUUtYTVoxQ3dkRDdZNEpkNFc0bkE5c0dYZ1FoOUpUNmVReVZjdENTNFNESEZ4Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
```

2、我们将会把证书设为环境变量。在设置时候请检查每一个参数。我们从 client-certificate-data 开始。

```
export clientcert=$(grep client-cert ~/.kube/config |cut -d" " -f 6)
echo $clientcert
```

3、使用类似的命令将 client-key-data 保存为环境变量

```
export clientkey=$(grep client-key-data ~/.kube/config |cut -d" " -f 6)
echo $clientkey
```

4、然后是 certificate-authority-data

```
export certauth=$(grep certificate-authority-data ~/.kube/config |cut -d" " -f 6)
echo $certauth
```

5、加密这些变量，供 curl 使用：

```
echo $clientcert | base64 -d > ./client.pem
echo $clientkey | base64 -d > ./client-key.pem
echo $certauth | base64 -d > ./ca.pem
```

6、从配置文件中读取 server 地址：

```
kubectl config view |grep server
server: https://192.168.56.100:6443
```

7、使用 curl 和刚刚加密的密钥文件来访问 API server：

```
curl --cert ./client.pem --key ./client-key.pem --cacert ./ca.pem https://192.168.56.100:6443/api/v1/pods
```

```
/etc/kubernetes/pki# ls
apiserver-key.pem  apiserver.pem  apiserver-pub.pem  ca-key.pem  ca.pem  ca-pub.pem  sa-key.pem  sa-pub.pem  tokens.csv

apiserver-key.pem：kube-apiserver的私钥文件
apiserver.pem：kube-apiserver的公钥证书
apiserver-pub.pem kube-apiserver的公钥文件
ca-key.pem：CA的私钥文件
ca.pem：CA的公钥证书
ca-pub.pem ：CA的公钥文件
sa-key.pem ：serviceaccount私钥文件
sa-pub.pem ：serviceaccount的公钥文件
```



